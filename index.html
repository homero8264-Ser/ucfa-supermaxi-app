<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UCFA Super Maxi 2025</title>
  <link rel="stylesheet" href="style.css?v=20250920-final">
  <link rel="manifest" href="manifest.json">
  <script>
    // Early capture of beforeinstallprompt so we don't miss it (useful on Fast/Local servers)
    window.__deferredPrompt = null;
    window.__beforeinstallprompt_received = false;
    window.addEventListener('beforeinstallprompt', (e) => {
      try { e.preventDefault(); } catch (err) {}
      window.__deferredPrompt = e;
      window.__beforeinstallprompt_received = true;
      console.log('beforeinstallprompt captured early (head)');
      // if btn exists show it
      try {
        const btn = document.getElementById('btn-install');
        if (btn) btn.style.display = 'inline-block';
      } catch (err) {}
    });
  </script>
  <meta name="theme-color" content="#4CAF50">
  <link rel="icon" href="imagenes/icons/icon-192.png">
  <link rel="apple-touch-icon" href="imagenes/icons/icon-192.png">
  <!-- Actualizaci√≥n forzada: 29/09/2025 -->
</head>
<body>
  <div class="app-container">
    <div class="header-compacto">
      <img src="imagenes/equipos/los-matadores.png" alt="Los Matadores" class="escudo-pequeno">
      <span class="titulo-compacto">UCFA Super Maxi 2025</span>
  <span id="app-version" style="margin-left:10px; font-size:12px; color:rgba(255,255,255,0.9); font-weight:700;"></span>
  <button id="btn-install" style="display:none; margin-left:8px; background:#fff; color:#333; border-radius:6px; padding:6px 8px; border:none; cursor:pointer; font-weight:700;">Instalar</button>
      <img src="imagenes/equipos/liga/ucfa_2024.png" alt="UCFA" class="escudo-pequeno">
    </div>
    
    <div class="navegacion-fija">
      <nav class="navegacion-pestanas">
        <button class="pestana active" onclick="cambiarPestana('clasificacion')">TABLA</button>
        <button class="pestana" onclick="cambiarPestana('goleadores')">GOLES</button>
        <button class="pestana" onclick="cambiarPestana('sanciones')">TARJETAS</button>
        <button class="pestana" onclick="cambiarPestana('resultados')">RESULTADOS</button>
        <button class="pestana" onclick="cambiarPestana('proxima')">Prox Fecha</button>
      </nav>
    </div>

    <div class="contenido-scrolleable">
      <div id="update-banner" style="display:none; position: fixed; right: 14px; bottom: 18px; background: #333; color: #fff; padding: 8px 12px; border-radius: 8px; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        Nueva versi√≥n disponible&nbsp;<button id="btn-update" style="background:#4CAF50;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer;margin-left:8px;">Actualizar</button>
      </div>
      <div id="contenido-clasificacion" class="contenido-pestana active">
  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
    <button id="boton-ver-mas" class="boton-vista" onclick="alternarVistaTabla()">VER MENOS</button>
          <button id="boton-tabla-gral" class="boton-vista" style="background: #42a5f5; color: #fff; border-radius: 8px; font-weight: bold; font-size: 13px; padding: 6px 16px; border: none; box-shadow: 0 2px 8px rgba(66,165,245,0.15); cursor: pointer;" onclick="alternarTablaGeneral()">TABLA GRAL</button>
  </div>
  <div id="contenedor-tablas"></div>
      </div>

      <div id="contenido-goleadores" class="contenido-pestana">
        <h2>Tabla de Goleadores</h2>
        <div id="contenedor-goleadores"></div>
      </div>

      <div id="contenido-sanciones" class="contenido-pestana">
        <h2>Sanciones</h2>
        <div id="contenedor-sanciones"></div>
      </div>

      <div id="contenido-resultados" class="contenido-pestana">
        <h2>Resultados Anteriores</h2>
        <div id="contenedor-resultados-anteriores"></div>
      </div>

      <div id="contenido-proxima" class="contenido-pestana">
        <h2>Pr√≥xima Fecha</h2>
        <div id="contenedor-proxima-fecha"></div>
      </div>

      <div id="contenido-admin" class="contenido-pestana">
        <h2>‚öôÔ∏è Administraci√≥n UCFA</h2>
        <div class="admin-section">
          <h3>üìù Agregar Resultado</h3>
          <div class="resultado-form">
            <div class="equipo-input">
              <label>Equipo Local:</label>
              <select id="equipoLocal">
                <option value="">Seleccionar equipo...</option>
                <option value="LA CORU√ëA">LA CORU√ëA</option>
                <option value="LOS MATADORES">LOS MATADORES</option>
                <option value="SAN MARTIN">SAN MARTIN</option>
                <option value="HALCONES">HALCONES</option>
                <option value="DINAMO">DINAMO</option>
                <option value="WARCALDE">WARCALDE</option>
                <option value="SANTOS">SANTOS</option>
                <option value="PENAROL">PENAROL</option>
                <option value="NECAXA">NECAXA</option>
                <option value="CARASUCIAS">CARASUCIAS</option>
                <option value="CRUZAZUL">CRUZAZUL</option>
                <option value="LA LOMITA">LA LOMITA</option>
                <option value="CERVECEROS">CERVECEROS</option>
                <option value="CHAZON">CHAZON</option>
                <option value="LASALLE">LASALLE</option>
                <option value="CLINICAS">CLINICAS</option>
                <option value="LA CANCHITA">LA CANCHITA</option>
                <option value="UNION Y AMISTAD">UNION Y AMISTAD</option>
              </select>
              <input type="number" id="golesLocal" placeholder="Goles" min="0" max="20">
            </div>
            <div class="vs-divider">VS</div>
            <div class="equipo-input">
              <label>Equipo Visitante:</label>
              <select id="equipoVisitante">
                <option value="">Seleccionar equipo...</option>
                <option value="LA CORU√ëA">LA CORU√ëA</option>
                <option value="LOS MATADORES">LOS MATADORES</option>
                <option value="SAN MARTIN">SAN MARTIN</option>
                <option value="HALCONES">HALCONES</option>
                <option value="DINAMO">DINAMO</option>
                <option value="WARCALDE">WARCALDE</option>
                <option value="SANTOS">SANTOS</option>
                <option value="PENAROL">PENAROL</option>
                <option value="NECAXA">NECAXA</option>
                <option value="CARASUCIAS">CARASUCIAS</option>
                <option value="CRUZAZUL">CRUZAZUL</option>
                <option value="LA LOMITA">LA LOMITA</option>
                <option value="CERVECEROS">CERVECEROS</option>
                <option value="CHAZON">CHAZON</option>
                <option value="LASALLE">LASALLE</option>
                <option value="CLINICAS">CLINICAS</option>
                <option value="LA CANCHITA">LA CANCHITA</option>
                <option value="UNION Y AMISTAD">UNION Y AMISTAD</option>
              </select>
              <input type="number" id="golesVisitante" placeholder="Goles" min="0" max="20">
            </div>
          </div>
          <div class="goleadores-section">
            <div class="goleadores-equipo">
              <h4>Goleadores Equipo Local</h4>
              <div id="goleadoresLocal"></div>
              <button onclick="agregarGoleador('local')" class="btn-agregar">+ Agregar Goleador</button>
            </div>
            <div class="goleadores-equipo">
              <h4>Goleadores Equipo Visitante</h4>
              <div id="goleadoresVisitante"></div>
              <button onclick="agregarGoleador('visitante')" class="btn-agregar">+ Agregar Goleador</button>
            </div>
          </div>
          <div class="botones-admin">
            <button onclick="procesarResultado()" class="btn-procesar">‚öΩ Procesar Resultado</button>
            <button onclick="limpiarFormulario()" class="btn-limpiar">üóëÔ∏è Limpiar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    // Cargar version.json y mostrar en header
    fetch('version.json').then(r => r.json()).then(v => {
      const el = document.getElementById('app-version');
      if (el) el.textContent = v.fechaActualizacion || '';
    }).catch(() => {});

    // Detect SW updates and show update banner
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        // another SW has taken control
        console.log('Service worker controller changed');
      });

  navigator.serviceWorker.register('service-worker.js').then(reg => {
        if (!navigator.serviceWorker.controller) return;

        if (reg.waiting) {
          showUpdateBanner(reg);
        }

        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          newSW.addEventListener('statechange', () => {
            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
              showUpdateBanner(reg);
            }
          });
        });
      });

      function showUpdateBanner(reg) {
        const banner = document.getElementById('update-banner');
        banner.style.display = 'block';
        document.getElementById('btn-update').onclick = () => {
          if (reg.waiting) {
            reg.waiting.postMessage({ action: 'skipWaiting' });
          }
          // reload to let the new SW take control
          window.location.reload();
        };
      }
    }
  </script>
  <script>
    // PWA install helper: capture beforeinstallprompt and show install button
    (function(){
      // Use early-captured prompt when available
      const btn = document.getElementById('btn-install');

      // Show button if we already captured the prompt in the head
      if (window.__deferredPrompt && btn) {
        btn.style.display = 'inline-block';
        window.__beforeinstallprompt_received = true;
      }

      if (btn) {
        btn.addEventListener('click', async () => {
          const promptEvent = window.__deferredPrompt;
          if (promptEvent) {
            try { btn.disabled = true; } catch (e) {}
            promptEvent.prompt();
            const choiceResult = await promptEvent.userChoice;
            console.log('User choice', choiceResult);
            window.__deferredPrompt = null;
            window.__beforeinstallprompt_received = false;
            btn.style.display = 'none';
            try { btn.disabled = false; } catch (e) {}
          } else {
            // fallback: show short help to add to home screen
            alert('Para instalar la app: abra el men√∫ del navegador y seleccione "Agregar a la pantalla de inicio" (Android) o use "Agregar a pantalla de inicio" en Safari (iOS).');
          }
        });
      }

      window.addEventListener('appinstalled', () => {
        console.log('PWA instalada');
        if (btn) btn.style.display = 'none';
      });
    })();
  </script>
  <!-- PWA debug panel -->
<div id="pwa-debug-panel" style="position:fixed;left:12px;bottom:12px;z-index:10000;background:rgba(0,0,0,0.75);color:#fff;padding:10px;border-radius:8px;font-family:monospace;font-size:13px;max-width:340px;line-height:1.3">
  <strong>PWA debug</strong>
  <div id="pwa-debug-content" style="margin-top:8px;white-space:pre-wrap">Cargando diagn√≥stico...</div>
  <div style="margin-top:8px;text-align:right"><button id="pwa-debug-refresh" style="background:#4CAF50;border:none;color:#fff;padding:6px 8px;border-radius:6px;cursor:pointer">Refrescar</button></div>
</div>

<script>
(function(){
  const out = document.getElementById('pwa-debug-content');
  const refresh = document.getElementById('pwa-debug-refresh');
  function logLine(s){ out.textContent += '\n' + s; }
  function clear(){ out.textContent = ''; }

  async function runChecks(){
    clear();
    logLine('URL: ' + location.href);
    logLine('Protocol: ' + location.protocol + '  Host: ' + location.hostname);

    // Manifest
    try{
      const r = await fetch('./manifest.json', {cache: 'no-store'});
      logLine('manifest.json HTTP: ' + r.status);
      const text = await r.text();
      try{
        const j = JSON.parse(text);
        logLine('manifest.name: ' + (j.name || '(missing)'));
        logLine('manifest.short_name: ' + (j.short_name || '(missing)'));
        logLine('manifest.start_url: ' + (j.start_url || '(missing)'));
        logLine('manifest.scope: ' + (j.scope || '(missing)'));
        if (Array.isArray(j.icons)) logLine('manifest.icons: ' + j.icons.map(i=>i.sizes || i.src).join(', '));
      }catch(e){ logLine('manifest parse error: ' + e.message); }
    }catch(err){ logLine('fetch manifest error: ' + err.message); }

    // Service worker
    if ('serviceWorker' in navigator){
      try{
        const regs = await navigator.serviceWorker.getRegistrations();
        if (!regs || regs.length === 0){ logLine('ServiceWorker: no registrations'); }
        else{
          for (const r of regs){
            logLine('SW registration scope: ' + r.scope);
            const sw = r.active || r.waiting || r.installing || null;
            logLine('SW state: ' + (sw ? sw.state : '(no active sw)'));
          }
        }
        logLine('navigator.serviceWorker.controller: ' + (!!navigator.serviceWorker.controller));
      }catch(e){ logLine('SW check error: ' + e.message); }
    } else {
      logLine('ServiceWorker API not available');
    }

    // beforeinstallprompt detection state
    logLine('Has beforeinstallprompt listener: ' + (!!window.__beforeinstallprompt_received));
    logLine('Is display-mode standalone? ' + (window.matchMedia('(display-mode: standalone)').matches));

    // Quick advice
    logLine('---');
    logLine('Advice: Manifest + SW + HTTPS/localhost required.');
    logLine('If manifest fetch returns non-200 or parse error, fix manifest path.');
    logLine('If SW not controlling page, try unregistering SW and hard reload.');
  }

  refresh.addEventListener('click', runChecks);
  runChecks();

  // hook beforeinstallprompt globally so panel shows if it happened
  window.addEventListener('beforeinstallprompt', (e) => {
    window.__beforeinstallprompt_received = true;
    // let existing code still handle it
    console.log('beforeinstallprompt fired (debug panel)');
  });
})();
</script>
</body>
</html>